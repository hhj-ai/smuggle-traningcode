#!/bin/bash

# gitupdate - automatically add, commit with message, and push changes

set -e  # Exit on error

# Function to print error and exit
error_exit() {
    echo "Error: $1" >&2
    exit 1
}

# Check if we're in a git repository
if ! git rev-parse --git-dir > /dev/null 2>&1; then
    error_exit "Not a git repository"
fi

# Step 1: git add .
echo "Adding all changes..."
git add .

# Step 2: Generate commit message from staged changes
# Get list of staged files
staged_files=$(git diff --cached --name-only)

if [ -z "$staged_files" ]; then
    echo "No changes to commit."
    exit 0
fi

# Count files
file_count=$(echo "$staged_files" | wc -l | tr -d ' ')

# Create commit message
if [ "$file_count" -eq 1 ]; then
    commit_message="Changed: $(basename "$staged_files")"
else
    # For multiple files, list first few
    first_files=$(echo "$staged_files" | head -3 | while read f; do basename "$f"; done | tr '\n' ', ' | sed 's/, $//')
    if [ "$file_count" -le 3 ]; then
        commit_message="Changed: $first_files"
    else
        commit_message="Changed $file_count files: $first_files, ..."
    fi
fi

# Step 3: git commit -m "message"
echo "Committing changes: $commit_message"
git commit -m "$commit_message"

# Step 4: git push
echo "Pushing to remote..."
git push

echo "Done."